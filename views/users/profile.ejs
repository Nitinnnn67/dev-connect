<% layout("/layout/boilerplate") %>

<link rel="stylesheet" href="/css/profile.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<!-- Profile Page Container -->
<div class="profile-container">
    <!-- Profile Header -->
    <section class="profile-header">
        <div class="header-background"></div>
        <div class="header-content">
            <div class="profile-main">
                <div class="avatar-wrapper">
                    <img src="<%= user.profilePicture || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name || user.username)}&size=150&background=11293A&color=fff` %>" alt="Profile" class="profile-avatar">
                    <% if (currentUser && user && user._id && currentUser._id.toString() === user._id.toString()) { %>
                        <button class="avatar-edit-btn">
                            <i class="fas fa-camera"></i>
                        </button>
                    <% } %>
                </div>
                <div class="profile-info">
                    <h1 class="profile-name"><%= user.name || user.username %></h1>
                    <p class="profile-username">@<%= user.username %></p>
                    <% if (user.bio) { %>
                        <p class="profile-bio"><%= user.bio %></p>
                    <% } %>
                    <div class="profile-meta">
                        <% if (user.location) { %>
                            <span><i class="fas fa-map-marker-alt"></i> <%= user.location %></span>
                        <% } %>
                        <% if (user.company) { %>
                            <span><i class="fas fa-building"></i> <%= user.company %></span>
                        <% } %>
                        <% if (user.showEmail && user.email) { %>
                            <span><i class="fas fa-envelope"></i> <%= user.email %></span>
                        <% } %>
                        <% if (user.phone) { %>
                            <span><i class="fas fa-phone"></i> <%= user.phone %></span>
                        <% } %>
                        <span><i class="fas fa-calendar-alt"></i> Joined <%= new Date(user.createdAt).toLocaleDateString('en-US', { month: 'long', year: 'numeric' }) %></span>
                        <% if (user.website) { %>
                            <span><i class="fas fa-link"></i> <a href="<%= user.website %>" target="_blank"><%= user.website.replace(/^https?:\/\//, '') %></a></span>
                        <% } %>
                    </div>
                </div>
                <div class="profile-actions">
                    <% if (currentUser && user && user._id && currentUser._id.toString() === user._id.toString()) { %>
                        <a href="/users/<%= user._id %>/edit" class="btn btn-primary">
                            <i class="fas fa-edit"></i>
                            <span>Edit Profile</span>
                        </a>
                    <% } %>
                    <button class="btn btn-secondary">
                        <i class="fas fa-share-alt"></i>
                        <span>Share</span>
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Profile Stats -->
    <section class="profile-stats">
        <div class="stat-item">
            <h3><%= (stats && stats.projectCount) || 0 %></h3>
            <p>Projects</p>
        </div>
        <div class="stat-item">
            <h3><%= (stats && stats.contributions) || 0 %></h3>
            <p>Contributions</p>
        </div>
        <div class="stat-item">
            <h3><%= user.skills ? user.skills.length : 0 %></h3>
            <p>Skills</p>
        </div>
        <div class="stat-item">
            <h3><%= projects && projects.length > 0 ? projects.filter(p => p.createdBy && p.createdBy._id && p.createdBy._id.toString() === user._id.toString()).length : 0 %></h3>
            <p>Created</p>
        </div>
    </section>

    <!-- Profile Content -->
    <div class="profile-content">
        <!-- Sidebar -->
        <aside class="profile-sidebar">
            <!-- Skills -->
            <div class="sidebar-card">
                <h3 class="card-title">
                    <i class="fas fa-code"></i>
                    Skills
                </h3>
                <div class="skills-list">
                    <% if (user.skills && user.skills.length > 0) { %>
                        <% user.skills.forEach(skill => { %>
                            <span class="skill-tag"><%= skill %></span>
                        <% }) %>
                    <% } else { %>
                        <p style="color: #94a3b8; font-size: 0.9rem;">No skills added yet</p>
                    <% } %>
                </div>
            </div>

            <!-- Social Links -->
            <div class="sidebar-card">
                <h3 class="card-title">
                    <i class="fas fa-share-nodes"></i>
                    Social Links
                </h3>
                <div class="social-links">
                    <% if (user.github) { %>
                        <a href="<%= user.github %>" target="_blank" class="social-link">
                            <i class="fab fa-github"></i>
                            <span>GitHub</span>
                        </a>
                    <% } %>
                    <% if (user.linkedin) { %>
                        <a href="<%= user.linkedin %>" target="_blank" class="social-link">
                            <i class="fab fa-linkedin"></i>
                            <span>LinkedIn</span>
                        </a>
                    <% } %>
                    <% if (user.twitter) { %>
                        <a href="<%= user.twitter %>" target="_blank" class="social-link">
                            <i class="fab fa-twitter"></i>
                            <span>Twitter</span>
                        </a>
                    <% } %>
                    <% if (user.portfolio) { %>
                        <a href="<%= user.portfolio %>" target="_blank" class="social-link">
                            <i class="fas fa-globe"></i>
                            <span>Portfolio</span>
                        </a>
                    <% } %>
                    <% if (!user.github && !user.linkedin && !user.twitter && !user.portfolio) { %>
                        <p style="color: #94a3b8; font-size: 0.9rem;">No social links added yet</p>
                    <% } %>
                </div>
            </div>

            <!-- Achievements -->
            <div class="sidebar-card">
                <h3 class="card-title">
                    <i class="fas fa-trophy"></i>
                    Achievements
                </h3>
                <div class="achievements-list">
                    <% 
                    const projectCount = projects && projects.length > 0 ? projects.filter(p => p.createdBy && p.createdBy._id && p.createdBy._id.toString() === user._id.toString()).length : 0;
                    const contributionCount = stats && stats.contributions ? stats.contributions : 0;
                    %>
                    
                    <% if(projectCount >= 10) { %>
                    <div class="achievement-item">
                        <i class="fas fa-rocket" style="color: #f59e0b;"></i>
                        <div>
                            <h4>Project Pioneer</h4>
                            <p>Created <%= projectCount %>+ projects</p>
                        </div>
                    </div>
                    <% } %>
                    
                    <% if(contributionCount >= 50) { %>
                    <div class="achievement-item">
                        <i class="fas fa-star" style="color: #eab308;"></i>
                        <div>
                            <h4>Top Contributor</h4>
                            <p><%= contributionCount %>+ contributions</p>
                        </div>
                    </div>
                    <% } %>
                    
                    <% if(user.skills && user.skills.length >= 10) { %>
                    <div class="achievement-item">
                        <i class="fas fa-code" style="color: #8b5cf6;"></i>
                        <div>
                            <h4>Tech Expert</h4>
                            <p>Mastered <%= user.skills.length %> skills</p>
                        </div>
                    </div>
                    <% } %>
                    
                    <% if(projectCount >= 5) { %>
                    <div class="achievement-item">
                        <i class="fas fa-fire" style="color: #ef4444;"></i>
                        <div>
                            <h4>Active Builder</h4>
                            <p>Created <%= projectCount %> projects</p>
                        </div>
                    </div>
                    <% } %>
                    
                    <% if(new Date() - new Date(user.createdAt) > 365 * 24 * 60 * 60 * 1000) { %>
                    <div class="achievement-item">
                        <i class="fas fa-calendar-check" style="color: #10b981;"></i>
                        <div>
                            <h4>Veteran</h4>
                            <p>Member for <%= Math.floor((new Date() - new Date(user.createdAt)) / (365 * 24 * 60 * 60 * 1000)) %> year(s)</p>
                        </div>
                    </div>
                    <% } %>
                    
                    <% if(projectCount === 0 && contributionCount === 0 && user.skills && user.skills.length < 10) { %>
                    <div style="text-align: center; padding: 1rem; color: #94a3b8; font-size: 0.9rem;">
                        <i class="fas fa-trophy" style="font-size: 2rem; margin-bottom: 0.5rem; display: block;"></i>
                        <p>No achievements yet. Start creating projects and contributing to earn badges!</p>
                    </div>
                    <% } %>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="profile-main-content">
            <!-- Tabs -->
            <div class="profile-tabs">
                <button class="tab-btn active" data-tab="projects">
                    <i class="fas fa-folder"></i>
                    Projects
                </button>
                <button class="tab-btn" data-tab="activity">
                    <i class="fas fa-clock"></i>
                    Activity
                </button>
                <button class="tab-btn" data-tab="contributions">
                    <i class="fas fa-code-branch"></i>
                    Contributions
                </button>
            </div>

            <!-- Tab Content: Projects -->
            <div class="tab-content active" id="projects">
                <div class="projects-grid">
                    <% if (projects && projects.length > 0) { %>
                        <% projects.forEach(project => { %>
                            <div class="project-card">
                                <div class="project-header">
                                    <h3><%= project.title || 'Untitled Project' %></h3>
                                    <span class="project-status status-<%= project.status || 'open' %>"><%= project.status || 'open' %></span>
                                </div>
                                <% if(project.description) { %>
                                    <p class="project-description"><%= project.description.substring(0, 100) %><%= project.description.length > 100 ? '...' : '' %></p>
                                <% } else { %>
                                    <p class="project-description">No description available</p>
                                <% } %>
                                <% if (project.techStack && project.techStack.length > 0) { %>
                                    <div class="project-tech">
                                        <% project.techStack.slice(0, 3).forEach(tech => { %>
                                            <span class="tech-tag"><%= tech %></span>
                                        <% }) %>
                                    </div>
                                <% } %>
                                <div class="project-footer">
                                    <div class="project-stats">
                                        <span><i class="fas fa-users"></i> <%= (project.members && project.members.length) || 0 %></span>
                                        <span><i class="fas fa-tasks"></i> <%= (project.tasks && project.tasks.length) || 0 %></span>
                                    </div>
                                    <a href="/projects/<%= project._id %>" class="project-link">View Project <i class="fas fa-arrow-right"></i></a>
                                </div>
                            </div>
                        <% }) %>
                    <% } else { %>
                        <div style="text-align: center; padding: 3rem; color: #94a3b8;">
                            <i class="fas fa-folder-open" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <p>No projects yet</p>
                        </div>
                    <% } %>
                </div>
            </div>

            <!-- Tab Content: Activity -->
            <div class="tab-content" id="activity">
                <div class="activity-list">
                    <% if (projects && projects.length > 0) { %>
                        <% 
                        // Sort projects by creation date (most recent first)
                        const sortedProjects = projects.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                        const recentProjects = sortedProjects.slice(0, 10);
                        %>
                        <% recentProjects.forEach(project => { %>
                            <div class="activity-item">
                                <div class="activity-icon">
                                    <% if (project.createdBy && project.createdBy._id && project.createdBy._id.toString() === user._id.toString()) { %>
                                        <i class="fas fa-plus"></i>
                                    <% } else { %>
                                        <i class="fas fa-user-plus"></i>
                                    <% } %>
                                </div>
                                <div class="activity-content">
                                    <% if (project.createdBy && project.createdBy._id && project.createdBy._id.toString() === user._id.toString()) { %>
                                        <p><strong>Created a new project</strong> "<a href="/projects/<%= project._id %>"><%= project.title || 'Untitled' %></a>"</p>
                                    <% } else { %>
                                        <p><strong>Joined project</strong> "<a href="/projects/<%= project._id %>"><%= project.title || 'Untitled' %></a>"</p>
                                    <% } %>
                                    <span class="activity-time"><%= new Date(project.createdAt).toLocaleDateString() %></span>
                                </div>
                            </div>
                        <% }) %>
                    <% } else { %>
                        <div style="text-align: center; padding: 3rem; color: #94a3b8;">
                            <i class="fas fa-clock" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <p>No activity yet</p>
                        </div>
                    <% } %>
                </div>
            </div>

            <!-- Tab Content: Contributions -->
            <div class="tab-content" id="contributions">
                <div class="contributions-content">
                    <h3>Task Contributions</h3>
                    <div class="activity-list">
                        <% 
                        let userTasks = [];
                        if(projects && projects.length > 0) {
                            projects.forEach(project => {
                                if(project.tasks && project.tasks.length > 0) {
                                    project.tasks.forEach(task => {
                                        if (task.assignedTo && task.assignedTo._id && task.assignedTo._id.toString() === user._id.toString()) {
                                            userTasks.push({
                                                task: task,
                                                projectTitle: project.title || 'Untitled',
                                                projectId: project._id
                                            });
                                        }
                                    });
                                }
                            });
                        }
                        %>
                        <% if (userTasks.length > 0) { %>
                            <% userTasks.forEach(item => { %>
                                <div class="activity-item">
                                    <div class="activity-icon">
                                        <% if (item.task.status === 'completed') { %>
                                            <i class="fas fa-check-circle" style="color: #10b981;"></i>
                                        <% } else if (item.task.status === 'in-progress') { %>
                                            <i class="fas fa-spinner" style="color: #f59e0b;"></i>
                                        <% } else { %>
                                            <i class="fas fa-circle" style="color: #6b7280;"></i>
                                        <% } %>
                                    </div>
                                    <div class="activity-content">
                                        <p><strong><%= item.task.title %></strong> in "<a href="/projects/<%= item.projectId %>"><%= item.projectTitle %></a>"</p>
                                        <p style="font-size: 0.85rem; color: #94a3b8; margin-top: 0.25rem;"><%= item.task.description || 'No description' %></p>
                                        <div style="margin-top: 0.5rem;">
                                            <span class="skill-tag" style="background-color: <%= item.task.priority === 'high' ? '#ef4444' : item.task.priority === 'medium' ? '#f59e0b' : '#10b981' %>; color: white; font-size: 0.75rem;"><%= item.task.priority %> priority</span>
                                            <span class="skill-tag" style="background-color: <%= item.task.status === 'completed' ? '#10b981' : item.task.status === 'in-progress' ? '#f59e0b' : '#6b7280' %>; color: white; font-size: 0.75rem;"><%= item.task.status %></span>
                                        </div>
                                    </div>
                                </div>
                            <% }) %>
                        <% } else { %>
                            <div style="text-align: center; padding: 3rem; color: #94a3b8;">
                                <i class="fas fa-tasks" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                                <p>No task contributions yet</p>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- GSAP Animation Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>

<!-- Profile Page Scripts -->
<script src="/js/profile.js"></script>
<script src="/animations/profile-animat.js"></script>

