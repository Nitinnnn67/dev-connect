<% layout("/layout/boilerplate") %>

<link rel="stylesheet" href="/css/projects.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<!-- Projects Page Container -->
<div class="projects-container">
    <!-- Page Header -->
    <section class="projects-header">
        <div class="header-content">
            <div class="header-text">
                <h1>Discover Projects</h1>
                <p>Find and join exciting projects that match your skills</p>
            </div>
            <a href="/projects/new" class="btn btn-primary">
                <i class="fas fa-plus"></i>
                Create Project
            </a>
        </div>
    </section>

    <!-- Search and Filters -->
    <section class="search-filter-section">
        <div class="search-bar">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="Search projects by name, description, or technology...">
        </div>
        
        <form method="GET" action="/projects" class="filters-container" id="filterForm">
            <!-- Category Filter -->
            <div class="filter-group">
                <select name="category" class="filter-select" onchange="document.getElementById('filterForm').submit()">
                    <option value="all" <%= (filters && filters.category === 'all') || !filters || !filters.category ? 'selected' : '' %>>All Categories</option>
                    <option value="web" <%= filters && filters.category === 'web' ? 'selected' : '' %>>Web Development</option>
                    <option value="mobile" <%= filters && filters.category === 'mobile' ? 'selected' : '' %>>Mobile Apps</option>
                    <option value="desktop" <%= filters && filters.category === 'desktop' ? 'selected' : '' %>>Desktop Apps</option>
                    <option value="ai-ml" <%= filters && filters.category === 'ai-ml' ? 'selected' : '' %>>AI/ML</option>
                    <option value="blockchain" <%= filters && filters.category === 'blockchain' ? 'selected' : '' %>>Blockchain</option>
                    <option value="game" <%= filters && filters.category === 'game' ? 'selected' : '' %>>Game Dev</option>
                    <option value="iot" <%= filters && filters.category === 'iot' ? 'selected' : '' %>>IoT</option>
                    <option value="other" <%= filters && filters.category === 'other' ? 'selected' : '' %>>Other</option>
                </select>
            </div>

            <!-- Status Filter -->
            <div class="filter-group">
                <select name="status" class="filter-select" onchange="document.getElementById('filterForm').submit()">
                    <option value="all" <%= (filters && filters.status === 'all') || !filters || !filters.status ? 'selected' : '' %>>All Status</option>
                    <option value="open" <%= filters && filters.status === 'open' ? 'selected' : '' %>>Open</option>
                    <option value="in-progress" <%= filters && filters.status === 'in-progress' ? 'selected' : '' %>>In Progress</option>
                    <option value="completed" <%= filters && filters.status === 'completed' ? 'selected' : '' %>>Completed</option>
                    <option value="closed" <%= filters && filters.status === 'closed' ? 'selected' : '' %>>Closed</option>
                </select>
            </div>

            <!-- Sort Options -->
            <select class="sort-select" name="sortBy" id="sortSelect" onchange="document.getElementById('filterForm').submit()">
                <option value="recent" <%= !filters || !filters.sortBy || filters.sortBy === 'recent' ? 'selected' : '' %>>Most Recent</option>
                <option value="popularity" <%= filters && filters.sortBy === 'popularity' ? 'selected' : '' %>>Most Popular</option>
                <option value="views" <%= filters && filters.sortBy === 'views' ? 'selected' : '' %>>Most Viewed</option>
                <option value="members" <%= filters && filters.sortBy === 'members' ? 'selected' : '' %>>Most Members</option>
                <% if(hasUserSkills) { %>
                <option value="recommended" <%= filters && filters.sortBy === 'recommended' ? 'selected' : '' %>>Recommended</option>
                <% } %>
            </select>
            
            <% if(filters && (filters.category || filters.status || filters.sortBy)) { %>
                <a href="/projects" class="btn btn-sm btn-outline-secondary" style="padding: 8px 15px;">
                    <i class="fas fa-times"></i> Clear Filters
                </a>
            <% } %>
        </form>
    </section>

    <!-- Projects Grid -->
    <section class="projects-grid-section">
        <div class="projects-grid" id="projectsGrid">
            <% if (projects.length === 0) { %>
                <!-- Empty State -->
                <div class="empty-state" style="grid-column: 1 / -1;">
                    <i class="fas fa-folder-open"></i>
                    <h3>No Projects Yet</h3>
                    <p>Be the first to create a project and start collaborating!</p>
                    <a href="/projects/new" class="btn btn-primary" style="margin-top: 20px;">
                        <i class="fas fa-plus"></i>
                        Create Project
                    </a>
                </div>
            <% } else { %>
                <% 
                    // Icon mapping for different project types
                    const iconMap = {
                        'javascript': 'fa-js',
                        'react': 'fa-react',
                        'node': 'fa-node-js',
                        'python': 'fa-python',
                        'web': 'fa-globe',
                        'mobile': 'fa-mobile-alt',
                        'ai': 'fa-brain',
                        'ml': 'fa-robot',
                        'data': 'fa-database',
                        'game': 'fa-gamepad',
                        'blockchain': 'fa-coins',
                        'iot': 'fa-microchip',
                        'default': 'fa-rocket'
                    };
                    
                    // Color gradients for variety
                    const gradients = [
                        'linear-gradient(135deg, #11293A 0%, #1e3a5f 100%)',
                        'linear-gradient(135deg, #3D4D55 0%, #11293A 100%)',
                        'linear-gradient(135deg, #B58863 0%, #D3C3B9 100%)',
                        'linear-gradient(135deg, #28a745 0%, #20c997 100%)',
                        'linear-gradient(135deg, #6f42c1 0%, #9b59b6 100%)',
                        'linear-gradient(135deg, #fd7e14 0%, #ffc107 100%)',
                        'linear-gradient(135deg, #dc3545 0%, #e74c3c 100%)',
                        'linear-gradient(135deg, #17a2b8 0%, #3498db 100%)'
                    ];
                %>
                
                <% projects.forEach((project, index) => { 
                    // Determine status class and text
                    let statusClass = '';
                    let statusText = '';
                    let statusFilter = '';
                    
                    if (project.status === 'open') {
                        statusClass = 'status-recruiting';
                        statusText = 'Recruiting';
                        statusFilter = 'recruiting';
                    } else if (project.status === 'in-progress') {
                        statusClass = 'status-active';
                        statusText = 'Active';
                        statusFilter = 'active';
                    } else if (project.status === 'completed') {
                        statusClass = 'status-completed';
                        statusText = 'Completed';
                        statusFilter = 'completed';
                    } else if (project.status === 'closed') {
                        statusClass = 'status-closed';
                        statusText = 'Closed';
                        statusFilter = 'closed';
                    }
                    
                    // Select icon based on tech stack
                    let projectIcon = iconMap['default'];
                    if (project.techStack && project.techStack.length > 0) {
                        const firstTech = project.techStack[0].toLowerCase();
                        for (let key in iconMap) {
                            if (firstTech.includes(key)) {
                                projectIcon = iconMap[key];
                                break;
                            }
                        }
                    }
                    
                    // Generate tech stack tags string for filtering
                    const techTags = project.techStack ? project.techStack.map(t => t.toLowerCase()).join(',') : '';
                    
                    // Select gradient
                    const gradient = gradients[index % gradients.length];
                    
                    // Owner info - check if createdBy exists
                    const ownerName = project.createdBy ? (project.createdBy.name || project.createdBy.username) : 'Unknown User';
                    const colors = ['11293A', 'B58863', '3D4D55', '2C5F2D', '97233F', '0E4C92', '8B4513', '2F4F4F'];
                    const bgColor = colors[index % colors.length];
                %>
                
                <div class="project-card" data-status="<%= statusFilter %>" data-tags="<%= techTags %>">
                    <div class="card-header">
                        <div class="project-icon" style="background: <%= gradient %>;">
                            <i class="fas <%= projectIcon %>"></i>
                        </div>
                        <div class="card-badges">
                            <span class="status-badge <%= statusClass %>"><%= statusText %></span>
                            <% if (project.matchPercentage && project.matchPercentage >= 30) { %>
                                <span class="match-badge badge-<%= project.matchBadge.color %>">
                                    <%= project.matchBadge.icon %> <%= project.matchPercentage %>%
                                </span>
                            <% } %>
                        </div>
                    </div>
                    
                    <h3 class="project-title"><%= project.title %></h3>
                    <p class="project-description">
                        <%= project.description.length > 120 ? project.description.substring(0, 120) + '...' : project.description %>
                    </p>
                    
                    <div class="project-tech">
                        <% if (project.techStack && project.techStack.length > 0) { %>
                            <% project.techStack.slice(0, 4).forEach(tech => { %>
                                <span class="tech-tag"><%= tech %></span>
                            <% }); %>
                            <% if (project.techStack.length > 4) { %>
                                <span class="tech-tag">+<%= project.techStack.length - 4 %></span>
                            <% } %>
                        <% } else { %>
                            <span class="tech-tag">General</span>
                        <% } %>
                    </div>
                    
                    <div class="project-meta">
                        <div class="meta-item">
                            <i class="fas fa-users"></i>
                            <span><%= project.members.length %><% if (project.teamSize) { %>/<%= project.teamSize %><% } %> Members</span>
                        </div>
                        <% if (project.duration) { %>
                            <div class="meta-item">
                                <i class="fas fa-calendar"></i>
                                <span><%= project.duration %></span>
                            </div>
                        <% } %>
                        <div class="meta-item">
                            <i class="fas fa-tasks"></i>
                            <span><%= project.tasks ? project.tasks.length : 0 %></span>
                        </div>
                    </div>
                    
                    <div class="project-footer">
                        <div class="project-owner">
                            <img src="https://ui-avatars.com/api/?name=<%= encodeURIComponent(ownerName) %>&size=32&background=<%= bgColor %>&color=fff" alt="<%= ownerName %>">
                            <span><%= ownerName %></span>
                        </div>
                        <a href="/projects/<%= project._id %>" class="view-btn">
                            View Details
                            <i class="fas fa-arrow-right"></i>
                        </a>
                    </div>
                </div>
                <% }); %>
            <% } %>
        </div>

        <!-- Empty State for Search/Filter -->
        <div class="empty-state" id="emptyState" style="display: none;">
            <i class="fas fa-search"></i>
            <h3>No Projects Found</h3>
            <p>Try adjusting your filters or search query</p>
        </div>
    </section>
</div>

<!-- GSAP Animation Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js"></script>

<!-- Projects Page Scripts -->
<script src="/js/projects.js"></script>
<script src="/animations/projects-animat.js"></script>
