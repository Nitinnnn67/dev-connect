<% layout("/layout/boilerplate") %>

<link rel="stylesheet" href="/css/project-detail.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<!-- Project Detail Container -->
<div class="project-detail-container">
    <!-- Project Header -->
    <section class="project-header">
        <div class="header-content">
            <div class="header-main">
                <a href="/projects" class="back-btn">
                    <i class="fas fa-arrow-left"></i>
                    <span>Back to Projects</span>
                </a>
                
                <div class="project-title-section">
                    <div class="project-icon">
                        <i class="fas fa-rocket"></i>
                    </div>
                    <div>
                        <h1><%= project.title %></h1>
                        <% if(project.description) { %>
                            <p class="project-tagline"><%= project.description.substring(0, 100) %><%= project.description.length > 100 ? '...' : '' %></p>
                        <% } %>
                </div>

                <div class="project-badges">
                    <% 
                        let statusClass = 'status-' + project.status;
                        let statusText = project.status === 'in-progress' ? 'In Progress' : 
                                        project.status.charAt(0).toUpperCase() + project.status.slice(1);
                    %>
                    <span class="status-badge <%= statusClass %>"><%= statusText %></span>
                    <% if(project.techStack && project.techStack.length > 0) { %>
                        <span class="category-badge"><%= project.techStack[0] %></span>
                    <% } %>
                </div>

                <div class="project-actions">
                    <% if(currentUser) { 
                        const isMember = project.members && project.members.length > 0 && 
                            project.members.some(member => 
                                member && member._id && member._id.toString() === currentUser._id.toString()
                            );
                        const isOwner = project.createdBy && 
                            (project.createdBy._id ? project.createdBy._id.toString() : project.createdBy.toString()) === currentUser._id.toString();
                    %>
                        
                        <% if(isOwner) { %>
                            <!-- Owner Actions -->
                            <a href="/projects/<%= project._id %>/analytics" class="btn btn-info">
                                <i class="fas fa-chart-line"></i>
                                Analytics
                            </a>
                            <a href="/projects/<%= project._id %>/join-requests" class="btn btn-warning">
                                <i class="fas fa-user-check"></i>
                                Join Requests
                                <% 
                                const pendingRequests = project.joinRequests ? project.joinRequests.filter(r => r.status === 'pending').length : 0;
                                if(pendingRequests > 0) { %>
                                    <span class="badge" style="background: #dc3545; margin-left: 5px;"><%= pendingRequests %></span>
                                <% } %>
                            </a>
                        <% } else if(!isMember) { %>
                            <!-- Non-member Actions -->
                            <% if(userInvitation) { %>
                                <form action="/projects/<%= project._id %>/invitations/<%= userInvitation._id %>/accept" method="POST" style="display: inline;">
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-envelope-open"></i>
                                        Accept Invitation
                                    </button>
                                </form>
                                <form action="/projects/<%= project._id %>/invitations/<%= userInvitation._id %>/decline" method="POST" style="display: inline;">
                                    <button type="submit" class="btn btn-outline-danger">
                                        Decline
                                    </button>
                                </form>
                            <% } else if(userJoinRequest) { %>
                                <button class="btn btn-secondary" disabled>
                                    <i class="fas fa-clock"></i>
                                    Request Pending
                                </button>
                            <% } else { %>
                                <button class="btn btn-primary" onclick="showJoinRequestModal()">
                                    <i class="fas fa-user-plus"></i>
                                    Request to Join
                                </button>
                            <% } %>
                        <% } else if(isMember && !isOwner) { %>
                            <button class="btn btn-secondary" disabled>
                                <i class="fas fa-check"></i>
                                Member
                            </button>
                        <% } %>
                        
                        <% if(isMember) { %>
                            <button class="btn btn-secondary" onclick="showInviteModal()">
                                <i class="fas fa-user-plus"></i>
                                Invite
                            </button>
                        <% } %>
                    <% } else { %>
                        <!-- Not logged in -->
                        <a href="/login" class="btn btn-primary">
                            <i class="fas fa-sign-in-alt"></i>
                            Login to Join
                        </a>
                    <% } %>
                    <button class="btn btn-secondary" id="shareBtn">
                        <i class="fas fa-share-alt"></i>
                        Share
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Project Info Bar -->
    <section class="project-info-bar">
        <div class="info-item">
            <i class="fas fa-users"></i>
            <div>
                <span class="info-label">Team Size</span>
                <span class="info-value"><%= (project.members && project.members.length) || 0 %>/<%= project.teamSize || 'Open' %> Members</span>
            </div>
        </div>
        <div class="info-item">
            <i class="fas fa-calendar"></i>
            <div>
                <span class="info-label">Duration</span>
                <span class="info-value"><%= project.duration || 'Not specified' %></span>
            </div>
        </div>
        <div class="info-item">
            <i class="fas fa-signal"></i>
            <div>
                <span class="info-label">Status</span>
                <% 
                    let statusDisplay = project.status === 'in-progress' ? 'In Progress' : 
                                    project.status.charAt(0).toUpperCase() + project.status.slice(1);
                %>
                <span class="info-value"><%= statusDisplay %></span>
            </div>
        </div>
        <div class="info-item">
            <i class="fas fa-chart-line"></i>
            <div>
                <span class="info-label">Progress</span>
                <% 
                    let totalTasks = project.tasks ? project.tasks.length : 0;
                    let completedTasks = project.tasks ? project.tasks.filter(t => t.status === 'completed').length : 0;
                    let progress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
                %>
                <span class="info-value"><%= progress %>%</span>
            </div>
        </div>
        <div class="info-item">
            <i class="fas fa-eye"></i>
            <div>
                <span class="info-label">Views</span>
                <span class="info-value"><%= project.analytics && project.analytics.views ? project.analytics.views : 0 %></span>
            </div>
        </div>
        <div class="info-item">
            <i class="fas fa-fire"></i>
            <div>
                <span class="info-label">Popularity</span>
                <span class="info-value"><%= project.analytics && project.analytics.popularity ? Math.round(project.analytics.popularity) : 0 %></span>
            </div>
        </div>
    </section>

    <!-- Project Content -->
    <div class="project-content">
        <!-- Main Content -->
        <div class="content-main">
            <!-- Description -->
            <div class="content-card">
                <h2><i class="fas fa-info-circle"></i> About This Project</h2>
                <p><%= project.description %></p>
                
                <% if(project.category) { %>
                    <div style="margin-top: 15px;">
                        <strong><i class="fas fa-folder"></i> Category:</strong>
                        <span class="badge" style="background: #17a2b8; color: white; padding: 5px 12px; margin-left: 8px;">
                            <%= project.category.charAt(0).toUpperCase() + project.category.slice(1) %>
                        </span>
                    </div>
                <% } %>
                
                <% if(project.tags && project.tags.length > 0) { %>
                    <div style="margin-top: 12px;">
                        <strong><i class="fas fa-tags"></i> Tags:</strong>
                        <% project.tags.forEach(tag => { %>
                            <span class="badge" style="background: #6c757d; color: white; padding: 5px 12px; margin: 5px 5px 5px 8px;">
                                <%= tag %>
                            </span>
                        <% }); %>
                    </div>
                <% } %>
            </div>

            <!-- Technology Stack -->
            <% if(project.techStack && project.techStack.length > 0) { %>
            <div class="content-card">
                <h2><i class="fas fa-code"></i> Technology Stack</h2>
                <div class="tech-stack">
                    <% project.techStack.forEach(tech => { %>
                        <span class="tech-tag"><%= tech %></span>
                    <% }); %>
                </div>
            </div>
            <% } %>

            <!-- Required Skills -->
            <% if(project.requiredSkills && project.requiredSkills.length > 0) { %>
            <div class="content-card">
                <h2><i class="fas fa-bullseye"></i> Required Skills</h2>
                <div class="tech-stack">
                    <% project.requiredSkills.forEach(skill => { %>
                        <span class="tech-tag"><%= skill %></span>
                    <% }); %>
                </div>
            </div>
            <% } %>

            <!-- Tasks -->
            <% if(project.tasks && project.tasks.length > 0) { %>
            <div class="content-card">
                <div class="tasks-header">
                    <h2><i class="fas fa-tasks"></i> Project Tasks</h2>
                    <% 
                        let totalTasks = project.tasks.length;
                        let completedTasks = project.tasks.filter(t => t.status === 'completed').length;
                        let progressPercent = Math.round((completedTasks / totalTasks) * 100);
                    %>
                    <div class="tasks-summary">
                        <span class="tasks-count"><%= completedTasks %>/<%= totalTasks %> completed</span>
                        <span class="tasks-percent"><%= progressPercent %>%</span>
                    </div>
                </div>
                
                <div class="progress-bar-container">
                    <div class="progress-bar" style="width: <%= progressPercent %>%"></div>
                </div>
                
                <!-- Filter Tabs -->
                <div class="task-filters">
                    <button class="filter-btn active" data-filter="all">All (<%= totalTasks %>)</button>
                    <button class="filter-btn" data-filter="todo">To Do (<%= project.tasks.filter(t => t.status === 'todo').length %>)</button>
                    <button class="filter-btn" data-filter="in-progress">In Progress (<%= project.tasks.filter(t => t.status === 'in-progress').length %>)</button>
                    <button class="filter-btn" data-filter="completed">Completed (<%= completedTasks %>)</button>
                </div>
                
                <div class="tasks-list">
                    <% project.tasks.forEach((task, index) => { %>
                        <div class="task-item task-<%= task.status %> task-priority-<%= task.priority %>" data-status="<%= task.status %>">
                            <div class="task-checkbox">
                                <% if(task.status === 'completed') { %>
                                    <i class="fas fa-check-circle"></i>
                                <% } else if(task.status === 'in-progress') { %>
                                    <i class="fas fa-spinner"></i>
                                <% } else { %>
                                    <i class="far fa-circle"></i>
                                <% } %>
                            </div>
                            <div class="task-content">
                                <div class="task-header">
                                    <h4><%= task.title %></h4>
                                    <div class="task-badges">
                                        <span class="task-priority priority-<%= task.priority %>">
                                            <i class="fas fa-flag"></i> <%= task.priority.charAt(0).toUpperCase() + task.priority.slice(1) %>
                                        </span>
                                        <span class="task-status <%= task.status %>">
                                            <%= task.status === 'in-progress' ? 'In Progress' : 
                                                task.status.charAt(0).toUpperCase() + task.status.slice(1) %>
                                        </span>
                                    </div>
                                </div>
                                <% if(task.description) { %>
                                    <p class="task-description"><%= task.description %></p>
                                <% } %>
                                <div class="task-meta">
                                    <% if(task.assignedTo) { %>
                                        <span class="task-assignee">
                                            <i class="fas fa-user-circle"></i>
                                            <strong><%= task.assignedTo.name || 'Unassigned' %></strong>
                                        </span>
                                    <% } else { %>
                                        <span class="task-assignee unassigned">
                                            <i class="fas fa-user-circle"></i>
                                            <strong>Unassigned</strong>
                                        </span>
                                    <% } %>
                                    <% if(task.dueDate) { %>
                                        <% 
                                            let dueDate = new Date(task.dueDate);
                                            let today = new Date();
                                            let isOverdue = dueDate < today && task.status !== 'completed';
                                            let daysUntil = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                                        %>
                                        <span class="task-due <%= isOverdue ? 'overdue' : '' %>">
                                            <i class="fas fa-calendar-alt"></i>
                                            <%= dueDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) %>
                                            <% if(isOverdue) { %>
                                                <span class="overdue-label">(Overdue)</span>
                                            <% } else if(daysUntil >= 0 && daysUntil <= 3 && task.status !== 'completed') { %>
                                                <span class="due-soon-label">(Due soon)</span>
                                            <% } %>
                                        </span>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    <% }); %>
                </div>
            </div>
            <% } %>

            <!-- Team Members -->
            <div class="content-card">
                <h2><i class="fas fa-users"></i> Team Members (<%= (project.members && project.members.length) || 0 %>)</h2>
                <div class="team-grid">
                    <% if(project.members && project.members.length > 0) { %>
                        <% project.members.forEach(member => { %>
                            <div class="team-member-card">
                                <img src="https://ui-avatars.com/api/?name=<%= encodeURIComponent(member.name || 'User') %>&size=80&background=random&color=fff" 
                                     alt="<%= member.name || 'User' %>">
                                <h3><%= member.name || 'Unknown' %></h3>
                                <p class="username">@<%= member.username || 'user' %></p>
                                <% if(member.skills && member.skills.length > 0) { %>
                                    <p class="skills"><%= member.skills.slice(0, 3).join(' â€¢ ') %></p>
                                <% } %>
                                <a href="/users/<%= member.username || member._id %>" class="view-profile">View Profile</a>
                            </div>
                        <% }); %>
                    <% } else { %>
                        <p>No team members yet.</p>
                    <% } %>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <aside class="content-sidebar">
            <!-- Project Owner -->
            <% if(project.createdBy) { %>
            <div class="sidebar-card">
                <h3>Project Owner</h3>
                <div class="owner-info">
                    <img src="https://ui-avatars.com/api/?name=<%= encodeURIComponent(project.createdBy.name || 'User') %>&size=60&background=11293A&color=fff" 
                         alt="<%= project.createdBy.name || 'User' %>">
                    <div>
                        <h4><%= project.createdBy.name || 'Unknown' %></h4>
                        <p>@<%= project.createdBy.username || 'user' %></p>
                        <a href="/users/<%= project.createdBy.username || project.createdBy._id %>">View Profile</a>
                    </div>
                </div>
            </div>
            <% } %>

            <!-- Required Skills -->
            <% if(project.requiredSkills && project.requiredSkills.length > 0) { %>
            <div class="sidebar-card">
                <h3>Looking For</h3>
                <div class="required-skills">
                    <% project.requiredSkills.forEach(skill => { %>
                        <div class="skill-item">
                            <i class="fas fa-check-circle"></i>
                            <span><%= skill %></span>
                        </div>
                    <% }); %>
                </div>
            </div>
            <% } %>

            <!-- Project Stats -->
            <div class="sidebar-card">
                <h3>Project Stats</h3>
                <div class="stats-list">
                    <div class="stat-item">
                        <span class="stat-label">Created</span>
                        <span class="stat-value"><%= new Date(project.createdAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) %></span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Last Updated</span>
                        <% 
                            const now = new Date();
                            const created = new Date(project.createdAt);
                            const diffTime = Math.abs(now - created);
                            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                            const diffHours = Math.floor(diffTime / (1000 * 60 * 60));
                            let timeAgo = '';
                            if(diffDays > 0) {
                                timeAgo = diffDays + ' day' + (diffDays > 1 ? 's' : '') + ' ago';
                            } else if(diffHours > 0) {
                                timeAgo = diffHours + ' hour' + (diffHours > 1 ? 's' : '') + ' ago';
                            } else {
                                timeAgo = 'Just now';
                            }
                        %>
                        <span class="stat-value"><%= timeAgo %></span>
                    </div>
                    <% if(project.tasks) { %>
                        <div class="stat-item">
                            <span class="stat-label">Total Tasks</span>
                            <span class="stat-value"><%= project.tasks.length %></span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Completed</span>
                            <span class="stat-value"><%= project.tasks.filter(t => t.status === 'completed').length %></span>
                        </div>
                    <% } %>
                </div>
            </div>

            <!-- Quick Actions -->
            <% if(currentUser) { 
                const isMemberCheck = project.members && project.members.length > 0 && 
                    project.members.some(member => member && member._id && member._id.toString() === currentUser._id.toString());
                const isOwnerCheck = project.createdBy && project.createdBy._id && 
                    project.createdBy._id.toString() === currentUser._id.toString();
            %>
            <div class="sidebar-card">
                <h3>Quick Actions</h3>
                <div class="quick-actions">
                    <% if(isMemberCheck) { %>
                        <a href="/projects/<%= project._id %>/dashboard" class="action-link">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>View Dashboard</span>
                        </a>
                        <a href="/projects/<%= project._id %>/chat" class="action-link">
                            <i class="fas fa-comments"></i>
                            <span>Team Chat</span>
                        </a>
                    <% } %>
                    <% if(isOwnerCheck) { %>
                        <a href="/projects/<%= project._id %>/edit" class="action-link">
                            <i class="fas fa-edit"></i>
                            <span>Edit Project</span>
                        </a>
                    <% } %>
                </div>
            </div>
            <% } %>
        </aside>
    </div>
</div>

<!-- GSAP Animation Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js"></script>

<!-- Project Detail Scripts -->
<script src="/js/project-detail.js"></script>